<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãŠã¿ãã˜ Dashboard ğŸ´âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            background: white;
            color: #667eea;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center mb-6">
            <h1 class="text-5xl font-bold text-white mb-2">
                AIãŠã¿ãã˜ ğŸ´
            </h1>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="flex flex-wrap border-b border-gray-200 bg-gray-50">
                <button onclick="switchTab('omikuji')" id="tab-omikuji" class="tab-active flex-1 px-4 py-4 text-center font-bold transition hover:bg-purple-100 focus:outline-none">
                    ğŸ´ ãŠã¿ãã˜
                </button>
                <button onclick="switchTab('chat')" id="tab-chat" class="tab-inactive flex-1 px-4 py-4 text-center font-bold transition hover:bg-purple-100 focus:outline-none">
                    ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ
                </button>
                <button onclick="switchTab('stats')" id="tab-stats" class="tab-inactive flex-1 px-4 py-4 text-center font-bold transition hover:bg-purple-100 focus:outline-none">
                    ğŸ“Š çµ±è¨ˆ
                </button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-inactive flex-1 px-4 py-4 text-center font-bold transition hover:bg-purple-100 focus:outline-none">
                    ğŸ“œ å±¥æ­´
                </button>
                <button onclick="switchTab('settings')" id="tab-settings" class="tab-inactive flex-1 px-4 py-4 text-center font-bold transition hover:bg-purple-100 focus:outline-none">
                    âš™ï¸ è¨­å®š
                </button>
                <button onclick="switchTab('trace')" id="tab-trace" class="tab-inactive flex-1 px-4 py-4 text-center font-bold transition hover:bg-purple-100 focus:outline-none">
                    ğŸ” ãƒˆãƒ¬ãƒ¼ã‚¹
                </button>
            </div>

            <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="p-8">
                <!-- ãŠã¿ãã˜ã‚¿ãƒ– -->
                <div id="content-omikuji" class="tab-content">
                    <!-- ãŠã¿ãã˜ã‚¨ãƒªã‚¢ -->
                    <div class="mb-8">
                        <div class="text-center mb-8">
                            <button 
                                id="drawButton"
                                class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-6 px-12 rounded-full text-2xl shadow-lg transform transition hover:scale-105 disabled:opacity-50"
                                onclick="drawOmikuji()"
                            >
                                ãŠã¿ãã˜ã‚’å¼•ãï¼
                            </button>
                        </div>

                        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
                        <div id="loading" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-600"></div>
                            <p class="text-gray-600 mt-4 text-lg">AI ãŒå ã„ä¸­...</p>
                        </div>

                        <!-- çµæœè¡¨ç¤º -->
                        <div id="result" class="hidden fade-in">
                        <div class="text-center mb-8 p-8 bg-gradient-to-r from-yellow-100 to-pink-100 rounded-2xl">
                            <div class="text-6xl mb-4" id="fortuneEmoji">ğŸ‰</div>
                            <h2 class="text-4xl font-bold mb-2" id="fortuneText">å¤§å‰</h2>
                            <div class="text-3xl mb-4" id="fortuneStars">â˜…â˜…â˜…â˜…â˜…</div>
                        </div>

                        <div class="bg-purple-50 rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-purple-900 mb-3 flex items-center">
                                <span class="text-2xl mr-2">ğŸ’¬</span>
                                AIã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                            </h3>
                            <p class="text-gray-800 leading-relaxed whitespace-pre-wrap" id="aiMessage"></p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-pink-50 rounded-xl p-4 text-center">
                                <div class="text-3xl mb-2">ğŸ¨</div>
                                <div class="text-sm text-gray-600 mb-1">ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼</div>
                                <div class="font-bold text-lg" id="luckyColor">èµ¤</div>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <div class="text-3xl mb-2">âœ¨</div>
                                <div class="text-sm text-gray-600 mb-1">ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ </div>
                                <div class="font-bold text-lg" id="luckyItem">ã‚¹ãƒãƒ›</div>
                            </div>
                            <div class="bg-green-50 rounded-xl p-4 text-center">
                                <div class="text-3xl mb-2">ğŸ“</div>
                                <div class="text-sm text-gray-600 mb-1">ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒãƒƒãƒˆ</div>
                                <div class="font-bold text-lg" id="luckySpot">ã‚«ãƒ•ã‚§</div>
                            </div>
                        </div>

                        <div class="text-center space-y-3">
                            <button 
                                onclick="switchTab('chat')"
                                class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-10 rounded-full transition transform hover:scale-105 shadow-lg"
                            >
                                ğŸ’¬ AIã¨ãƒãƒ£ãƒƒãƒˆã™ã‚‹
                            </button>
                            <div>
                                <button 
                                    onclick="reset()"
                                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full transition"
                                >
                                    ã‚‚ã†ä¸€å›å¼•ã ğŸ´
                                </button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–ï¼ˆNEWï¼ï¼‰ -->
                <div id="content-chat" class="tab-content hidden">
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 h-[calc(100vh-300px)] flex flex-col">
                        <div class="mb-4">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <span class="text-3xl mr-3">ğŸ’¬</span>
                                AIã¨ãƒãƒ£ãƒƒãƒˆ
                            </h2>
                            <p class="text-gray-600 mt-2 text-sm">
                                ãŠã¿ãã˜ã®çµæœã«ã¤ã„ã¦è³ªå•ã—ãŸã‚Šã€é‹å‹¢ã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚‚ã‚‰ãŠã†ï¼âœ¨
                            </p>
                        </div>

                        <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
                        <div id="chatMessages" class="bg-white rounded-xl p-4 mb-4 flex-1 overflow-y-auto space-y-3">
                            <div class="text-center text-gray-400 text-sm py-8">
                                ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦AIã¨ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼âœ¨<br>
                                ãŠã¿ãã˜ã‚’å¼•ã„ãŸå¾Œã«è³ªå•ã™ã‚‹ã®ã‚‚ãŠã™ã™ã‚ï¼ğŸ´
                            </div>
                        </div>

                        <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="chatInput" 
                                placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...ï¼ˆä¾‹ï¼šä»Šæ—¥ã®é‹å‹¢ã©ã†ï¼Ÿï¼‰" 
                                class="flex-1 border border-gray-300 rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                onkeypress="if(event.key === 'Enter') sendMessage()"
                            >
                            <button 
                                onclick="sendMessage()"
                                class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold px-8 py-3 rounded-full transition transform hover:scale-105"
                            >
                                é€ä¿¡ ğŸ“¤
                            </button>
                        </div>
                    </div>
                </div>

                <!-- çµ±è¨ˆã‚¿ãƒ– -->
                <div id="content-stats" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“Š ã‚ãªãŸã®ãŠã¿ãã˜çµ±è¨ˆ</h2>
                    
                    <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                    <div class="grid md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl p-6 text-center">
                            <div class="text-3xl mb-2">ğŸ´</div>
                            <div class="text-sm text-gray-600 mb-1">ç·å¼•ãå›æ•°</div>
                            <div class="text-3xl font-bold text-purple-900" id="totalCount">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-pink-100 to-pink-200 rounded-xl p-6 text-center">
                            <div class="text-3xl mb-2">ğŸ‰</div>
                            <div class="text-sm text-gray-600 mb-1">å¤§å‰ç‡</div>
                            <div class="text-3xl font-bold text-pink-900" id="daiKichiRate">0%</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-6 text-center">
                            <div class="text-3xl mb-2">ğŸ¯</div>
                            <div class="text-sm text-gray-600 mb-1">çš„ä¸­ç‡</div>
                            <div class="text-3xl font-bold text-blue-900" id="accuracyRate">0%</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-100 to-green-200 rounded-xl p-6 text-center">
                            <div class="text-3xl mb-2">ğŸ”¥</div>
                            <div class="text-sm text-gray-600 mb-1">é€£ç¶šè¨˜éŒ²</div>
                            <div class="text-3xl font-bold text-green-900" id="streak">0æ—¥</div>
                        </div>
                    </div>

                    <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">é‹å‹¢åˆ†å¸ƒ</h3>
                        <canvas id="fortuneChart" height="80"></canvas>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">æœˆåˆ¥æ¨ç§»</h3>
                        <canvas id="monthlyChart" height="80"></canvas>
                    </div>
                </div>

                <!-- å±¥æ­´ã‚¿ãƒ– -->
                <div id="content-history" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“œ ãŠã¿ãã˜å±¥æ­´</h2>
                    
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <div class="mb-6 flex gap-4">
                        <select id="filterFortune" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">ã™ã¹ã¦ã®é‹å‹¢</option>
                            <option value="å¤§å‰">å¤§å‰</option>
                            <option value="ä¸­å‰">ä¸­å‰</option>
                            <option value="å°å‰">å°å‰</option>
                            <option value="å‰">å‰</option>
                            <option value="æœ«å‰">æœ«å‰</option>
                            <option value="å‡¶">å‡¶</option>
                        </select>
                        <input type="date" id="filterDate" class="border border-gray-300 rounded-lg px-4 py-2">
                        <button onclick="filterHistory()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                        </button>
                    </div>

                    <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
                    <div id="historyList" class="space-y-4">
                        <div class="bg-gray-50 rounded-xl p-6 text-center text-gray-500">
                            ã¾ã ãŠã¿ãã˜ã‚’å¼•ã„ã¦ã„ã¾ã›ã‚“
                        </div>
                    </div>
                </div>

                <!-- è¨­å®šã‚¿ãƒ– -->
                <div id="content-settings" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">âš™ï¸ è¨­å®š</h2>
                    
                    <!-- ãƒãƒªã‚·ãƒ¼è¨­å®š -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center">
                            <span class="text-2xl mr-2">ğŸ›¡ï¸</span>
                            ãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆAgentCore Policyï¼‰
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="enableDailyLimit" class="mr-2">
                                    <span>1æ—¥ã®å¼•ãå›æ•°ã‚’åˆ¶é™ã™ã‚‹</span>
                                </label>
                                <div class="ml-6 mt-2">
                                    <input type="number" id="dailyLimit" value="3" min="1" max="100" 
                                           class="border border-gray-300 rounded px-3 py-1 w-20">
                                    <span class="ml-2 text-gray-600">å›ã¾ã§</span>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="enableCooldown" class="mr-2">
                                    <span>é€£ç¶šå¼•ãã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</span>
                                </label>
                                <div class="ml-6 mt-2">
                                    <input type="number" id="cooldownMinutes" value="30" min="1" max="1440" 
                                           class="border border-gray-300 rounded px-3 py-1 w-20">
                                    <span class="ml-2 text-gray-600">åˆ†é–“</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é€šçŸ¥è¨­å®š -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ”” é€šçŸ¥è¨­å®š</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="notifyDailyOmikuji" class="mr-2">
                                <span>æ¯æ—¥ã®ãŠã¿ãã˜ã‚’ãƒªãƒã‚¤ãƒ³ãƒ‰</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="notifyAchievement" class="mr-2">
                                <span>å®Ÿç¸¾è§£é™¤æ™‚ã«é€šçŸ¥</span>
                            </label>
                        </div>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                        <div class="space-y-3">
                            <div>
                                <button onclick="exportData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                    ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                            </div>
                            <div>
                                <button onclick="clearChat()" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700">
                                    ğŸ’¬ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤
                                </button>
                            </div>
                            <div>
                                <button onclick="clearData()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                                    ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒˆãƒ¬ãƒ¼ã‚¹ã‚¿ãƒ– -->
                <div id="content-trace" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ” AIãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆObservabilityï¼‰</h2>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹</h3>
                            <span id="traceStatus" class="text-sm text-gray-500">å¾…æ©Ÿä¸­...</span>
                        </div>
                        <div id="traceLog" class="bg-white rounded-lg p-4 font-mono text-sm space-y-2 max-h-96 overflow-y-auto">
                            <div class="text-gray-500">ãŠã¿ãã˜ã‚’å¼•ãã¨AIã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-xl p-6">
                            <h4 class="font-bold mb-2 text-blue-900">ğŸ”— CloudWatch Logs</h4>
                            <p class="text-sm text-gray-700 mb-3">è©³ç´°ãªãƒ­ã‚°ã‚’ç¢ºèª</p>
                            <a href="https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#logsV2:log-groups/log-group/$252Faws$252Fbedrock-agentcore$252Fruntimes$252Fmy_agent-9NBXM54pmz-DEFAULT" 
                               target="_blank"
                               class="text-blue-600 hover:underline text-sm">
                                CloudWatch ã§ç¢ºèª â†’
                            </a>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-6">
                            <h4 class="font-bold mb-2 text-purple-900">ğŸ“Š GenAI Dashboard</h4>
                            <p class="text-sm text-gray-700 mb-3">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</p>
                            <a href="https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#gen-ai-observability/agent-core" 
                               target="_blank"
                               class="text-purple-600 hover:underline text-sm">
                                ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã â†’
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <script>
        const AGENT_ARN = 'arn:aws:bedrock-agentcore:ap-northeast-1:226484346947:runtime/my_agent-9NBXM54pmz';
        const AWS_REGION = 'ap-northeast-1';

        // é‹å‹¢ã«å¯¾å¿œã™ã‚‹çµµæ–‡å­—
        const fortuneEmojis = {
            'å¤§å‰': 'ğŸ‰',
            'ä¸­å‰': 'ğŸ˜Š',
            'å°å‰': 'ğŸŒ¸',
            'å‰': 'âœ¨',
            'æœ«å‰': 'ğŸ€',
            'å‡¶': 'ğŸ’ª'
        };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
        const STORAGE_KEY = 'omikuji_history';

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            const tabs = ['omikuji', 'chat', 'stats', 'history', 'settings', 'trace'];
            tabs.forEach(tab => {
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
                document.getElementById(`tab-${tab}`).classList.add('tab-inactive');
                document.getElementById(`content-${tab}`).classList.add('hidden');
            });

            // é¸æŠã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-${tabName}`).classList.remove('tab-inactive');
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // ã‚¿ãƒ–ã”ã¨ã®åˆæœŸåŒ–å‡¦ç†
            if (tabName === 'stats') {
                updateStats();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'chat') {
                // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                setTimeout(() => {
                    document.getElementById('chatInput')?.focus();
                }, 100);
            }
        }

        // ãŠã¿ãã˜ã‚’å¼•ã
        async function drawOmikuji() {
            const button = document.getElementById('drawButton');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');

            result.classList.add('hidden');
            button.disabled = true;
            loading.classList.remove('hidden');

            // ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ­ã‚°é–‹å§‹
            addTraceLog('ãŠã¿ãã˜å¼•ãé–‹å§‹...');
            addTraceLog('APIå‘¼ã³å‡ºã—ä¸­...');

            try {
                // æœ¬ç‰©ã®APIå‘¼ã³å‡ºã—
                // Lambda APIç›´æ¥å‘¼ã³å‡ºã—ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
                const API_ENDPOINT = 'https://6zzt3d5iej.execute-api.ap-northeast-1.amazonaws.com';
                const response = await fetch(`${API_ENDPOINT}/api/omikuji`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: 'ãŠã¿ãã˜å¼•ããŸã„ï½ï¼',
                        sessionId: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('ãŠã¿ãã˜ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                
                addTraceLog(`é‹å‹¢: ${data.fortune_data.fortune} ã‚’æ±ºå®š`);
                addTraceLog('âœ… ãŠã¿ãã˜ç”Ÿæˆå®Œäº†ï¼');

                displayResult(data);
                saveHistory(data.fortune_data);
                
                // ãƒãƒ£ãƒƒãƒˆã«ã‚‚ãŠã¿ãã˜çµæœã‚’è¿½åŠ 
                const fortuneData = data.fortune_data;
                const chatMessage = `ãŠã¿ãã˜å¼•ã„ãŸã‚ˆï½ï¼ğŸ´âœ¨\n\nã€${fortuneData.fortune}ã€‘${fortuneData.stars}\n\nãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼: ${fortuneData.lucky_color} ğŸ¨\nãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ : ${fortuneData.lucky_item} âœ¨\nãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒãƒƒãƒˆ: ${fortuneData.lucky_spot} ğŸ“\n\nä½•ã‹èããŸã„ã“ã¨ã‚ã‚‹ï¼ŸğŸ˜ŠğŸ’•`;
                addChatMessage('assistant', chatMessage);

            } catch (err) {
                console.error('Error:', err);
                addTraceLog('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                loading.classList.add('hidden');
                button.disabled = false;
            }
        }

        function displayResult(data) {
            const result = document.getElementById('result');
            const fortuneData = data.fortune_data;
            
            document.getElementById('fortuneEmoji').textContent = fortuneEmojis[fortuneData.fortune] || 'ğŸ´';
            document.getElementById('fortuneText').textContent = fortuneData.fortune;
            document.getElementById('fortuneStars').textContent = fortuneData.stars;

            const aiResponse = JSON.parse(data.result);
            const message = aiResponse.content[0].text;
            document.getElementById('aiMessage').textContent = message;

            document.getElementById('luckyColor').textContent = fortuneData.lucky_color;
            document.getElementById('luckyItem').textContent = fortuneData.lucky_item;
            document.getElementById('luckySpot').textContent = fortuneData.lucky_spot;

            result.classList.remove('hidden');
        }

        function reset() {
            document.getElementById('result').classList.add('hidden');
        }

        // ========================================
        // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆNEWï¼ï¼‰
        // ========================================
        
        const CHAT_STORAGE_KEY = 'omikuji_chat_history';
        let currentSessionId = Date.now();
        
        // ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
        function initChat() {
            const savedChat = localStorage.getItem(CHAT_STORAGE_KEY);
            if (savedChat) {
                const chatHistory = JSON.parse(savedChat);
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢
                
                chatHistory.forEach((msg, index) => {
                    const msgDate = new Date(msg.timestamp);
                    const dateStr = msgDate.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
                    const timestamp = msgDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    
                    // æ—¥ä»˜åŒºåˆ‡ã‚Š
                    const prevMsg = chatHistory[index - 1];
                    const prevDate = prevMsg ? new Date(prevMsg.timestamp).toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' }) : null;
                    
                    if (!prevDate || prevDate !== dateStr) {
                        const dateSeparator = document.createElement('div');
                        dateSeparator.className = 'text-center text-xs text-gray-400 my-4';
                        dateSeparator.innerHTML = `â”â”â” ${msgDate.toLocaleDateString('ja-JP')} â”â”â”`;
                        messagesContainer.appendChild(dateSeparator);
                    }
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    const messageDiv = document.createElement('div');
                    
                    if (msg.role === 'user') {
                        messageDiv.className = 'flex justify-end items-start gap-2';
                        messageDiv.innerHTML = `
                            <span class="text-xs text-gray-400 mt-1">${timestamp}</span>
                            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[70%]">
                                <p class="text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                            </div>
                        `;
                    } else {
                        messageDiv.className = 'flex justify-start items-start gap-2';
                        messageDiv.innerHTML = `
                            <div class="bg-gray-100 text-gray-800 rounded-2xl rounded-tl-none px-4 py-3 max-w-[70%]">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-sm font-bold text-purple-600">AIå ã„å¸«</span>
                                    <span class="text-xs text-gray-500">Memory ON</span>
                                </div>
                                <p class="text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                            </div>
                            <span class="text-xs text-gray-400 mt-1">${timestamp}</span>
                        `;
                    }
                    
                    messagesContainer.appendChild(messageDiv);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            addChatMessage('user', message);
            input.value = '';
            
            // ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ­ã‚°
            addTraceLog(`ãƒãƒ£ãƒƒãƒˆé€ä¿¡: "${message}"`);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingId = addChatMessage('assistant', 'è€ƒãˆä¸­...', true);
            
            try {
                // æœ¬ç‰©ã®APIå‘¼ã³å‡ºã—
                // Lambda APIç›´æ¥å‘¼ã³å‡ºã—ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
                const API_ENDPOINT = 'https://6zzt3d5iej.execute-api.ap-northeast-1.amazonaws.com';
                const response = await fetch(`${API_ENDPOINT}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('ãƒãƒ£ãƒƒãƒˆã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                const aiResponse = JSON.parse(data.response);
                const aiMessage = aiResponse.content[0].text;
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤
                document.getElementById(loadingId).remove();
                
                // AIå¿œç­”è¡¨ç¤º
                addChatMessage('assistant', aiMessage);
                
                addTraceLog(`AIå¿œç­”å®Œäº†`);
                
            } catch (err) {
                console.error('Chat error:', err);
                document.getElementById(loadingId).remove();
                addChatMessage('assistant', 'ã”ã‚ã‚“ï¼ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¡ã‚ƒã£ãŸğŸ’¦ ã‚‚ã†ä¸€å›è©¦ã—ã¦ã¿ã¦ï¼');
                addTraceLog('âŒ ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ©ãƒ¼');
            }
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addChatMessage(role, content, isLoading = false) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã‚‰æ¡ˆå†…ã‚’å‰Šé™¤
            if (messagesContainer.children[0]?.textContent.includes('ãŠã¿ãã˜ã‚’å¼•ãã‹')) {
                messagesContainer.innerHTML = '';
            }
            
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('ja-JP', { month: '2-digit', day: '2-digit' });
            
            // æ—¥ä»˜åŒºåˆ‡ã‚Šã‚’è¿½åŠ ï¼ˆå‰å›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æ—¥ä»˜ãŒé•ã†å ´åˆï¼‰
            const lastMessage = messagesContainer.lastElementChild;
            const lastDate = lastMessage?.dataset?.date;
            if (!lastDate || lastDate !== dateStr) {
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'text-center text-xs text-gray-400 my-4';
                dateSeparator.dataset.date = dateStr;
                dateSeparator.innerHTML = `â”â”â” ${now.toLocaleDateString('ja-JP')} â”â”â”`;
                messagesContainer.appendChild(dateSeparator);
            }
            
            const messageDiv = document.createElement('div');
            const messageId = `msg-${Date.now()}-${Math.random()}`;
            messageDiv.id = messageId;
            messageDiv.dataset.date = dateStr;
            
            if (role === 'user') {
                messageDiv.className = 'flex justify-end items-start gap-2';
                messageDiv.innerHTML = `
                    <span class="text-xs text-gray-400 mt-1">${timestamp}</span>
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[70%]">
                        <p class="text-sm whitespace-pre-wrap">${escapeHtml(content)}</p>
                    </div>
                `;
                
                // å±¥æ­´ä¿å­˜
                saveChatMessage(role, content);
                
            } else {
                messageDiv.className = 'flex justify-start items-start gap-2';
                const loadingClass = isLoading ? 'animate-pulse' : '';
                messageDiv.innerHTML = `
                    <div class="bg-gray-100 text-gray-800 rounded-2xl rounded-tl-none px-4 py-3 max-w-[70%] ${loadingClass}">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-bold text-purple-600">AIå ã„å¸«</span>
                            <span class="text-xs text-gray-500">Memory ON</span>
                        </div>
                        <p class="text-sm whitespace-pre-wrap">${escapeHtml(content)}</p>
                    </div>
                    <span class="text-xs text-gray-400 mt-1">${timestamp}</span>
                `;
                
                if (!isLoading) {
                    saveChatMessage(role, content);
                }
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ä¿å­˜
        function saveChatMessage(role, content) {
            let chatHistory = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
            chatHistory.push({
                role,
                content,
                timestamp: new Date().toISOString(),
                sessionId: currentSessionId
            });
            
            // æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
            if (chatHistory.length > 100) {
                chatHistory = chatHistory.slice(-100);
            }
            
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
        }

        // AIå¿œç­”ç”Ÿæˆï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰
        function generateAIResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            // ãŠã¿ãã˜çµæœå–å¾—
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const lastFortune = history[0];
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆèªè­˜
            if (msg.includes('ãŠã¿ãã˜') || msg.includes('é‹å‹¢')) {
                if (lastFortune) {
                    return `ã•ã£ãå¼•ã„ãŸãŠã¿ãã˜ã¯ã€${lastFortune.fortune}ã€‘ã ã£ãŸã­ï¼âœ¨\n${lastFortune.stars}\n\nãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ã¯${lastFortune.lucky_color}ã€ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã¯${lastFortune.lucky_item}ã ã‚ˆï½ğŸ’•\n\n${lastFortune.lucky_spot}ã«è¡Œãã¨ã„ã„ã“ã¨ã‚ã‚‹ã‹ã‚‚ï¼ğŸ˜Š`;
                } else {
                    return 'ã¾ã ãŠã¿ãã˜å¼•ã„ã¦ãªã„ã‚ˆï½ï¼ğŸ´\nä¸Šã®ãƒœã‚¿ãƒ³æŠ¼ã—ã¦ãŠã¿ãã˜å¼•ã„ã¦ã¿ã¦ï¼âœ¨';
                }
            }
            
            if (msg.includes('ãƒ©ãƒƒã‚­ãƒ¼') || msg.includes('ã‚‰ã£ããƒ¼')) {
                if (lastFortune) {
                    return `ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã¯ã€${lastFortune.lucky_item}ã€‘ã ã‚ˆï½ï¼âœ¨\n\nã‚ã¨${lastFortune.lucky_color}ã®ã‚‚ã®èº«ã«ã¤ã‘ã‚‹ã¨ã„ã„ã‚ˆï¼ğŸ’•\n\n${lastFortune.lucky_spot}ã«è¡Œã£ã¦ã¿ã‚‹ã®ã‚‚ãŠã™ã™ã‚ï½ğŸ˜Š`;
                }
            }
            
            if (msg.includes('çµ±è¨ˆ') || msg.includes('ãƒ‡ãƒ¼ã‚¿')) {
                const daiKichiCount = history.filter(h => h.fortune === 'å¤§å‰').length;
                const daiKichiRate = history.length > 0 ? ((daiKichiCount / history.length) * 100).toFixed(1) : 0;
                return `ä»Šã¾ã§ã®ãƒ‡ãƒ¼ã‚¿è¦‹ã¦ã¿ã‚‹ã­ï¼ğŸ“Š\n\nç·å¼•ãå›æ•°: ${history.length}å›\nå¤§å‰ç‡: ${daiKichiRate}%\n\nã™ã”ã„ã˜ã‚ƒã‚“ï¼âœ¨\nã€Œçµ±è¨ˆã€ã‚¿ãƒ–ã§ã‚°ãƒ©ãƒ•ã‚‚è¦‹ã‚Œã‚‹ã‚ˆï½ğŸ“ˆ`;
            }
            
            if (msg.includes('ã‚¢ãƒ‰ãƒã‚¤ã‚¹') || msg.includes('ã©ã†ã™ã‚Œã°')) {
                return 'ä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã­ï¼ğŸ’¡\n\n1. ãƒã‚¸ãƒ†ã‚£ãƒ–ã«è€ƒãˆã‚‹ âœ¨\n2. ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ æŒã¤ ğŸ\n3. ç¬‘é¡”ã‚’å¿˜ã‚Œãªã„ ğŸ˜Š\n4. æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ ğŸš€\n\né‹æ°—ã¯è‡ªåˆ†ã§ä½œã‚‹ã‚‚ã®ã ã‚ˆï½ğŸ’ªğŸ’•';
            }
            
            if (msg.includes('ã‚ã‚ŠãŒã¨') || msg.includes('thank')) {
                return 'ã©ã†ã„ãŸã—ã¾ã—ã¦ï½ï¼ğŸ˜ŠğŸ’•\n\nã¾ãŸä½•ã‹èããŸã„ã“ã¨ã‚ã£ãŸã‚‰è¨€ã£ã¦ã­ï¼\næ¯æ—¥ãŠã¿ãã˜å¼•ã„ã¦é‹æ°—ãƒã‚§ãƒƒã‚¯ã—ã‚ˆï½ğŸ´âœ¨';
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”
            const responses = [
                'ãã‚Œã‚ã£ã¡ã‚ƒé¢ç™½ã„ã­ï¼ğŸ˜Šâœ¨\nä»–ã«æ°—ã«ãªã‚‹ã“ã¨ã‚ã‚‹ï¼Ÿ',
                'ãªã‚‹ã»ã©ã­ï½ï¼ğŸ’¡\nãŠã¿ãã˜ã®çµæœã¨ã‹çµ±è¨ˆã‚‚è¦‹ã¦ã¿ã‚‹ï¼Ÿ',
                'ãã†ãªã‚“ã ï½ï¼âœ¨\nä»Šæ—¥ã®é‹å‹¢ã¨ã‹æ°—ã«ãªã‚‹ï¼ŸğŸ´',
                'ã„ã„ã­ï¼ğŸ˜ŠğŸ’•\nä½•ã‹ä»–ã«ã‚‚æ‰‹ä¼ãˆã‚‹ã“ã¨ã‚ã£ãŸã‚‰è¨€ã£ã¦ã­ï¼',
                'ã‚ã‹ã£ãŸï¼âœ¨\nãŠã¿ãã˜å¼•ã„ã¦ã¿ãŸã‚Šã€çµ±è¨ˆè¦‹ã¦ã¿ãŸã‚Šã—ã¦ã­ï½ğŸ“Š'
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ãƒãƒ£ãƒƒãƒˆã‚¯ãƒªã‚¢
        function clearChat() {
            if (confirm('âš ï¸ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰Šé™¤ã™ã‚‹ã¨å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\nï¼ˆæ³¨ï¼šLocalStorageã®ã¿ã‚¯ãƒªã‚¢ã€‚AgentCoreã®Memoryã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ï¼‰')) {
                localStorage.removeItem(CHAT_STORAGE_KEY);
                document.getElementById('chatMessages').innerHTML = `
                    <div class="text-center text-gray-400 text-sm py-8">
                        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦AIã¨ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼âœ¨<br>
                        ãŠã¿ãã˜ã‚’å¼•ã„ãŸå¾Œã«è³ªå•ã™ã‚‹ã®ã‚‚ãŠã™ã™ã‚ï¼ğŸ´
                    </div>
                `;
                addTraceLog('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆLocalStorageã®ã¿ï¼‰');
                alert('âœ… ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
        window.addEventListener('load', () => {
            initChat();
        });

        // ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ­ã‚°è¿½åŠ 
        function addTraceLog(message) {
            const traceLog = document.getElementById('traceLog');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-gray-700';
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            
            if (traceLog.children[0]?.textContent.includes('ãŠã¿ãã˜ã‚’å¼•ãã¨')) {
                traceLog.innerHTML = '';
            }
            
            traceLog.appendChild(logEntry);
            traceLog.scrollTop = traceLog.scrollHeight;
            
            document.getElementById('traceStatus').textContent = 'å®Ÿè¡Œä¸­...';
            setTimeout(() => {
                document.getElementById('traceStatus').textContent = 'å¾…æ©Ÿä¸­...';
            }, 3000);
        }

        // å±¥æ­´ã‚’ä¿å­˜
        function saveHistory(fortuneData) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history.unshift({
                ...fortuneData,
                id: Date.now()
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="bg-gray-50 rounded-xl p-6 text-center text-gray-500">ã¾ã ãŠã¿ãã˜ã‚’å¼•ã„ã¦ã„ã¾ã›ã‚“</div>';
                return;
            }

            historyList.innerHTML = history.map(item => `
                <div class="bg-gray-50 rounded-xl p-6 hover:bg-gray-100 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="text-4xl">${fortuneEmojis[item.fortune]}</div>
                            <div>
                                <div class="font-bold text-xl text-gray-800">${item.fortune}</div>
                                <div class="text-gray-600">${item.stars}</div>
                            </div>
                        </div>
                        <div class="text-right text-sm text-gray-600">
                            <div>${new Date(item.timestamp).toLocaleDateString('ja-JP')}</div>
                            <div>${new Date(item.timestamp).toLocaleTimeString('ja-JP')}</div>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2 text-sm">
                        <span class="bg-pink-100 text-pink-800 px-3 py-1 rounded-full">ğŸ¨ ${item.lucky_color}</span>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">âœ¨ ${item.lucky_item}</span>
                        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">ğŸ“ ${item.lucky_spot}</span>
                    </div>
                </div>
            `).join('');
        }

        // çµ±è¨ˆã‚’æ›´æ–°
        function updateStats() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            
            // ç·å›æ•°
            document.getElementById('totalCount').textContent = history.length;

            // å¤§å‰ç‡
            const daiKichiCount = history.filter(h => h.fortune === 'å¤§å‰').length;
            const daiKichiRate = history.length > 0 ? ((daiKichiCount / history.length) * 100).toFixed(1) : 0;
            document.getElementById('daiKichiRate').textContent = `${daiKichiRate}%`;

            // çš„ä¸­ç‡ï¼ˆãƒ‡ãƒ¢ç”¨ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            const accuracyRate = history.length > 0 ? (70 + Math.random() * 20).toFixed(1) : 0;
            document.getElementById('accuracyRate').textContent = `${accuracyRate}%`;

            // é€£ç¶šè¨˜éŒ²
            document.getElementById('streak').textContent = `${history.length}æ—¥`;

            // ã‚°ãƒ©ãƒ•æç”»
            drawFortuneChart(history);
            drawMonthlyChart(history);
        }

        // é‹å‹¢åˆ†å¸ƒã‚°ãƒ©ãƒ•
        function drawFortuneChart(history) {
            const ctx = document.getElementById('fortuneChart');
            if (window.fortuneChartInstance) {
                window.fortuneChartInstance.destroy();
            }

            const fortuneCounts = {
                'å¤§å‰': 0, 'ä¸­å‰': 0, 'å°å‰': 0, 'å‰': 0, 'æœ«å‰': 0, 'å‡¶': 0
            };
            history.forEach(h => {
                if (fortuneCounts[h.fortune] !== undefined) {
                    fortuneCounts[h.fortune]++;
                }
            });

            window.fortuneChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(fortuneCounts),
                    datasets: [{
                        label: 'å›æ•°',
                        data: Object.values(fortuneCounts),
                        backgroundColor: [
                            '#fbbf24', '#f59e0b', '#fb923c', '#a78bfa', '#c084fc', '#e879f9'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        // æœˆåˆ¥æ¨ç§»ã‚°ãƒ©ãƒ•
        function drawMonthlyChart(history) {
            const ctx = document.getElementById('monthlyChart');
            if (window.monthlyChartInstance) {
                window.monthlyChartInstance.destroy();
            }

            const monthlyData = {};
            history.forEach(h => {
                const month = new Date(h.timestamp).toLocaleDateString('ja-JP', { month: 'short' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });

            window.monthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'ãŠã¿ãã˜å›æ•°',
                        data: Object.values(monthlyData),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getStars(fortune) {
            const starMap = {
                'å¤§å‰': 'â˜…â˜…â˜…â˜…â˜…',
                'ä¸­å‰': 'â˜…â˜…â˜…â˜…â˜†',
                'å°å‰': 'â˜…â˜…â˜…â˜†â˜†',
                'å‰': 'â˜…â˜…â˜…â˜†â˜†',
                'æœ«å‰': 'â˜…â˜…â˜†â˜†â˜†',
                'å‡¶': 'â˜…â˜†â˜†â˜†â˜†'
            };
            return starMap[fortune] || 'â˜…â˜…â˜…â˜†â˜†';
        }

        function getFortunedComment(fortune) {
            const comments = {
                'å¤§å‰': 'è¶…ãƒ©ãƒƒã‚­ãƒ¼ï¼ä»Šæ—¥ã¯æœ€é«˜ã ã‚ˆï½ï¼ğŸ˜ğŸ’•',
                'ä¸­å‰': 'ã„ã„æ„Ÿã˜ã˜ã‚ƒã‚“ï¼ğŸ˜Šâœ¨',
                'å°å‰': 'ã¾ã‚ã¾ã‚ã„ã„æ„Ÿã˜ã ã­ï½ğŸŒ¸',
                'å‰': 'æ™®é€šã«ã„ã„æ—¥ã ã‚ˆï¼âœ¨',
                'æœ«å‰': 'ã¡ã‚‡ã£ã¨åœ°å‘³ã ã‘ã©OKï¼ğŸ€',
                'å‡¶': 'ä»Šæ—¥ã¯ç„¡ç†ã—ãªã„ã§ã­ï½ğŸ’ª'
            };
            return comments[fortune] || '';
        }

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function filterHistory() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆTODOï¼‰
            alert('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ï¼');
        }

        function exportData() {
            const history = localStorage.getItem(STORAGE_KEY);
            const blob = new Blob([history], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `omikuji_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function clearData() {
            if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadHistory();
                updateStats();
            }
        }
    </script>
</body>
</html>
